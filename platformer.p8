pico-8 cartridge // http://www.pico-8.com
version 41
__lua__
-- init / properties

function _init()
	
	music(0)
	x=90
	y=24
	w=8
	h=8
	dx=0
	dy=0
	walk_speed=1
	gravity=1
	max_fall_speed=8
	sprite=2
	atime=0
	moving=false
	jump_speed=6
	ground_flag=0

end




-->8
-- animation

function animate_player()
	
	if moving and time() - atime > 0.2 then
		
		sprite+=1
		atime=time()		
		
		if sprite > 5 then
			sprite=2
		end
		
	elseif not(moving) then
		sprite=2
	end

end
-->8
-- update

function _update()
	handle_input()
	move_player()	
	animate_player()
end
-->8
-- draw

function _draw()	
	cls()
	map(0,0)
	spr(0, 10, 10)
	spr(sprite, x, y)
end
-->8
-- collisions

function collide_map(aim)
	-- uses properties in _init()
	
	local x1=0
	local x2=0
	local y1=0
	local y2=0
	
	printh(aim)
	
	if aim=="none" then
		return false
	elseif aim=="left" then
		x1=x+1				y1=y
		x2=x+1				y2=y+h-1
	elseif aim=="right" then
		x1=x+w-1		y1=y
		x2=x+w-1		y2=y+h-1
	elseif aim=="up" then
		x1=x+2				y1=y-1
		x2=x+w-2		y2=y-1
	elseif aim=="down" then
		x1=x+2						y1=y+h
		x2=x+w-2				y2=y+h
	end
	
	-- convert pixels to tiles
	x1/=8	y1/=8 x2/=8 y2/=8
	
	-- check if bounding box intersects with map tile
	if fget(mget(x1,y1), ground_flag)
	or fget(mget(x1,y2), ground_flag)
	or fget(mget(x2,y1), ground_flag)
	or fget(mget(x2,y2), ground_flag) then
		return true
	else
		return false
	end
end

-- move one step at a time to perfectly collide with map
function iterate_to_collision(step_x,step_y,iterations)
	if step_x > 0 then
		h_dir="right"
	elseif step_x < 0 then
		h_dir="left"
	else
		h_dir="none"
	end
	
	if step_y > 0 then
		v_dir="down"
	elseif step_y < 0 then
		v_dir="up"
	else
		v_dir="none"
	end
	
	for i=1,iterations do
		if collide_map(h_dir) then
			printh("collided horiz")
			dx=0
		else
			x=x+step_x
		end
		
		if collide_map(v_dir) then
			printh("collided vert")
			dy=0
		else
			y=y+step_y
		end
	end
end

function move_player()
	if dx==0 then
		moving = false
	else
		moving = true
	end
	
	dy=dy+gravity
	if(dy>max_fall_speed) then
		dy=max_fall_speed
	end
	
	printh("dx")
	printh(dx)
	printh("dy")
	printh(dy)
	
	if dx==0 and dy~=0 then
		local step_x = 0
		local step_y = dy/abs(dy)
		iterate_to_collision(step_x,step_y,abs(dy))
	elseif dx~=0 and dy==0 then
		local step_x = dx/abs(dx)
		local step_y = 0
		iterate_to_collision(step_x,step_y,abs(dx))
	elseif abs(dx) < abs(dy) then
		local step_x = dx/abs(dy)
		local step_y = dy/abs(dy)
		iterate_to_collision(step_x,step_y,abs(dy))
	elseif abs(dx) > abs(dy) then
	 local step_x = dx/abs(dx)
	 local step_y = dy/abs(dx)
	 iterate_to_collision(step_x,step_y,abs(dx))
	elseif abs(dx) == abs(dy) and dx~=0 then
		local step_x = dx/abs(dx)
		local step_y = dy/abs(dy)
		iterate_to_collision(step_x,step_y,abs(dx))
	end
end
-->8
-- input

function handle_input()
	moving=false
	left=0
	right=0
	
	if(btn(0)) then
		left=1
	end
	
	if(btn(1)) then
		right=1
	end
	
	dx=right-left
	dx=dx*walk_speed
	
	if(btn(5) and jump_released and collide_map("down")) then
		dy=-jump_speed
		jump_released=false
	end
	
	if not btn(5) then
		jump_released=true
	end
end

__gfx__
000aa000cccccccc0099999000999990009999900099999000000000000000000000000000000000000000000000000000000000000000000000000000000000
00aaaa00cccccccc0097979000979790009797900097979000000000000000000000000000000000000000000000000000000000000000000000000000000000
0a7aa7a0cccccccc0099999000999990009999900099999000000000000000000000000000000000000000000000000000000000000000000000000000000000
aaa77aaacccccccc0097779000977790009777900097779000000000000000000000000000000000000000000000000000000000000000000000000000000000
aaa77aaacccccccc0000900000009000000090000000900000000000000000000000000000000000000000000000000000000000000000000000000000000000
0a7aa7a0cccccccc0009990000099900000999000009990000000000000000000000000000000000000000000000000000000000000000000000000000000000
00aaaa00cccccccc0000900000009900000090000009900000000000000000000000000000000000000000000000000000000000000000000000000000000000
000aa000cccccccc0009090000009000000909000000900000000000000000000000000000000000000000000000000000000000000000000000000000000000
bbbbbbbbbbbbbbbbbbbbbbbbbbbbbbbb000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
b4bbbb44bb4bbb4b4b44b4b4bb4bbbb4000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
444b44f44b44b44444444444f444bbb4000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
44444444444644d4464d444444444b44000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4f4444444f444444444444f444f444f4000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4444f444444444444444644444444444000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
44d444444444f446464444f444444d46000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
44444446464444444444444464444444000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
44444444444444440000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4f444464446444460000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
44444444444444440000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4444f4444f444f440000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
44f44444444444440000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
44444444444446440000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
46446444464444440000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
4444444f4444f4440000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__gff__
0000000000000000000000000000000001010101000000000000000000000000010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__map__
0101010101010101010101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010101010101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010112010101010101100101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
0101010101010101010112210101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
1101010101010101011321210101010100000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2012101213101312102121211010121300000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
2021202121202120212121212021212000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__sfx__
000100000600012000120001e0001e0001e0001e0001e0001e0001e0001e0001e0000d0002af002af002ca002aa0028a0026a0025a0024a0023a0023a0022a0020a001ba0018a0018a000e9000c9000990008900
001000002105000000000000000000000000000000000000000000000000000000002305000000000000000000000240500000000000000000000000000000000000000000000000000000000000000000000000
00100000000502f8002c8000305005050320000305001050270000505012000000003180000000010000000000000000502f8002c800030500505032000030500105027000050500000000000000000000000000
001000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000003550005000000000000075500000000000
001000002105000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000000
__music__
02 01020344

